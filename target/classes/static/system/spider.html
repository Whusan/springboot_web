<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/main.css">
    <title>电影数据 - 数据列表</title>
    <style>
        .layui-table {
            display: none;
        }

        #add_navigation_form_container {
            padding: 20px;
        }

        #btn_add_navigation_container {
            margin-top: 30px;
            margin-bottom: 0;
            text-align: center;
        }
    </style>
</head>

<body>
<div id="page_header"></div>
<div id="page_nav_left"></div>
<div id="page_main_container">
    <div id="main_container">

        <div>
            <input type="date" id="time1" value="">起始时间
            <input type="date" id="time2" value="">终止时间
            <button id="btn_search" class="layui-btn" onclick="navigationListFunc()">搜索</button>
        </div>
        <table class="layui-table">
            <colgroup>
                <col width="50">
                <col width="50">
                <col width="50">
                <col width="100">
                <col width="50">
                <col width="80">
                <col width="300">
                <col width="30">
                <!--                <col width="100">-->
            </colgroup>
            <thead>
            <tr>
                <th>#</th>
                <th>电影名称</th>
                <th>导演</th>
                <th>编剧</th>
                <th>类型</th>
                <th>上映时间</th>
                <th>简介</th>
                <th>豆瓣url</th>
                <!--                <th>操作</th>-->
            </tr>
            </thead>
            <tbody id="navigationListContainer"></tbody>
        </table>
        <div id="pagination"></div>
    </div>
</div>
<div id="page_footer"></div>
<div id="add_navigation_html_container" style="display: none;">
    <div id="add_navigation_form_container">
    </div>
</div>
<script src="../layui/layui.js"></script>
<script src="../js/config.js"></script>
<!--<script src="../js/system/spider.js"></script>-->
<script>
    /**
     * Created by Caby on 6/3/17.
     */
    ;(function () {
        function navigationListFunc() {
            var _utils = layui.commonUtils, _loading = layui.commonLoading, $ = layui.jquery, _layer = layui.layer,
                _dateFormat = layui.dateFormat, _pager = layui.laypage, _form = layui.form;
            // fetch data
            var _nagvigationListContainer = $('#navigationListContainer');
            var _time1 = $('#time1').value;
            var _time2 = $('#time2').value;
            var _navigationList = {};
            function getNavigationList(obj, first) {
                if (first) return;
                _nagvigationListContainer.html('');
                var pageNo = obj.curr;
                _loading.showLoading();
                $.get('/api/spider/list', {pageNo: pageNo - 1, time1:_time1, time2:_time2}, function (result) {
                    _loading.hideLoading();
                    $('.layui-table').show();
                    var pageSize = 20, totalCount = 0;
                    if (result.code == 0) {

                        pageNo = result.content.pageNo + 1;
                        pageSize = result.content.pageSize;
                        totalCount = result.content.navigationCount;
                        $.each(result.content.navigationList, function (idx, navigation) {
                            var tr = $('<tr class="navigation_info_row" data-nid="' + navigation.id + '"></tr>');
                            tr.append('<td>' + (idx + 1) + '</td>');
                            tr.append('<td>' + navigation.name + '</td>');
                            tr.append('<td>' + navigation.director + '</td>');
                            tr.append('<td>' + navigation.write + '</td>');
                            tr.append('<td>' + navigation.type + '</td>');
                            tr.append('<td>' + navigation.date + '</td>');
                            tr.append('<td>' + navigation.introdduction + '</td>');
                            tr.append('<td>' + navigation.movieurl + '</td>');
                            // tr.append('<td><div class="layui-btn-group" data-nid="' + navigation.mid + '">'
                            //     +   '<button class="layui-btn layui-btn-primary layui-btn-small btn_delete_navigation" title="删除">'
                            //     +       '<i class="layui-icon">&#xe640;</i>'
                            //     +   '</button>'
                            //     + '</div></td>');

                            _nagvigationListContainer.append(tr);
                            _navigationList[navigation.id] = navigation;
                        });
                    } else {
                        _layer.msg(result.msg ? result.msg : '获取电影数据失败');
                    }
                    !first && setTimeout(function () {
                        _pager.render({elem: 'pagination', count: totalCount, limit: pageSize, curr: pageNo, jump: getNavigationList});
                    }, 0);
                });
            }

            // // add or edit navigation
            // var _btnAddNavigation = $('#btn_add_navigation');
            // var _addNavigationHtmlContainer = $('#add_navigation_html_container');
            // var _dialogIdx = false;
            // function showEditNavigationDialog(nid) {
            //     if (_dialogIdx !== false) return;
            //     nid = nid || 0;
            //     var navigationInfo = _navigationList[nid] ? _navigationList[nid] : false;
            //     _addNavigationHtmlContainer.find('input[name=nid]').attr('value', nid);
            //     _addNavigationHtmlContainer.find('input[name=name]').attr('value', navigationInfo ? navigationInfo.name : '');
            //     _addNavigationHtmlContainer.find('input[name=orderNumber]').attr('value', navigationInfo ? navigationInfo.orderNumber : '0');
            //
            //     var checkbox = $('input:checkbox[name=status]').removeAttr('checked');
            //     if (!navigationInfo || navigationInfo.status == 0) {
            //         checkbox.attr('checked', 'checked');
            //     }
            //     _btnAddNavigation.addClass('layui-btn-disabled');
            //     _dialogIdx = _layer.open({
            //         type: 1,
            //         area: ['400px', '320px'],
            //         title: '添加接口',
            //         content: _addNavigationHtmlContainer.html(),
            //         cancel: closeAddNavigationDialog
            //     });
            //     _form.render();
            // }
            // // add navigation
            // _btnAddNavigation.click(showEditNavigationDialog);
            // // confirm to add navigation
            // _form.on('submit(confirm)', function (data) {
            //     _loading.showLoading();
            //     var requestUrl = '/api/navigation/add';
            //     if (data.field.nid && data.field.nid > 0) {
            //         requestUrl = '/api/navigation/update';
            //     }
            //     if (typeof data.field.status == 'undefined') {
            //         data.field.status = 1;
            //     }
            //     _utils.put(requestUrl, data.field, function (result) {
            //         _loading.hideLoading();
            //         if (result.code != 0) {
            //             _layer.alert(result.msg || '未知错误');
            //             return;
            //         }
            //         _layer.msg('成功', {time: 1500}, function () {
            //             window.location.reload(true);
            //         });
            //     });
            //     return false;
            // });
            // close add navigation dialog
            function closeAddNavigationDialog() {
                if (_dialogIdx !== false) {
                    _layer.close(_dialogIdx);
                }
                _btnAddNavigation.removeClass('layui-btn-disabled');
                _dialogIdx = false;
            }
            // edit navigation
            var _bodyEle = $('body');
            _bodyEle.on('click', '.btn_edit_navigation', function () {
                var nid = $(this).parent().attr('data-nid');
                alert(nid);
                if (!nid) {
                    layer.msg('找不到导航栏的id，无法进行编辑，请刷新页面再试');
                    return;
                }
                showEditNavigationDialog(nid);
            });
            // delete navigation
            _bodyEle.on('click', '.btn_delete_navigation', function () {
                var nid = $(this).parent().attr('data-nid');
                if (!nid) {
                    layer.msg('找不到导航栏的id，无法进行删除，请刷新页面再试');
                    return;
                }
                _layer.confirm('确定要删除此导航栏吗？', function (confirmDialog) {
                    _layer.close(confirmDialog);
                    _loading.showLoading();
                    _utils.delete('/api/spider/del', {nid: nid}, function (result) {
                        _loading.hideLoading();
                        if (result.code != 0) {
                            _layer.alert(result.msg || '未知错误');
                            return;
                        }
                        layer.msg('删除成功', {time: 1500}, function () {
                            window.location.reload(true);
                        });
                    });
                });
            });

            // do fetch data
            getNavigationList({curr: 1});
        }

        layui.use(
            [
                'pageBuilder',
                'commonUtils',
                'commonLoading',
                'jquery',
                'layer',
                'dateFormat',
                'laypage',
                'form'
            ],
            navigationListFunc
        );
    } ());


    function navigationListFunc() {
        var _utils = layui.commonUtils, _loading = layui.commonLoading, $ = layui.jquery, _layer = layui.layer,
            _dateFormat = layui.dateFormat, _pager = layui.laypage, _form = layui.form;
        // fetch data
        var _nagvigationListContainer = $('#navigationListContainer');
        var _time1 = $('#time1').value;
        var _time2 = $('#time2').value;
        var _navigationList = {};
        function getNavigationList(obj, first) {
            if (first) return;
            _nagvigationListContainer.html('');
            var  pageNo= obj.curr;
            alert(pageNo);
            _loading.showLoading();
            $.get('/api/spider/list', {pageNo: pageNo - 1, time1:_time1, time2:_time2}, function (result) {
                _loading.hideLoading();
                $('.layui-table').show();
                var pageSize = 20, totalCount = 0;

                if (result.code == 0) {
                    pageNo = result.content.pageNo + 1;
                    pageSize = result.content.pageSize;
                    totalCount = result.content.navigationCount;
                    $.each(result.content.navigationList, function (idx, navigation) {

                        var tr = $('<tr class="navigation_info_row" data-nid="' + navigation.id + '"></tr>');
                        tr.append('<td>' + (idx + 1) + '</td>');
                        tr.append('<td>' + navigation.name + '</td>');
                        tr.append('<td>' + navigation.director + '</td>');
                        tr.append('<td>' + navigation.write + '</td>');
                        tr.append('<td>' + navigation.type + '</td>');
                        tr.append('<td>' + navigation.date + '</td>');
                        tr.append('<td>' + navigation.introdduction + '</td>');
                        tr.append('<td>' + navigation.movieurl + '</td>');
                        // tr.append('<td><div class="layui-btn-group" data-nid="' + navigation.mid + '">'
                        //     +   '<button class="layui-btn layui-btn-primary layui-btn-small btn_delete_navigation" title="删除">'
                        //     +       '<i class="layui-icon">&#xe640;</i>'
                        //     +   '</button>'
                        //     + '</div></td>');

                        _nagvigationListContainer.append(tr);
                        _navigationList[navigation.id] = navigation;
                    });
                } else {
                    _layer.msg(result.msg ? result.msg : '获取电影数据失败');
                }
                !first && setTimeout(function () {
                    _pager.render({elem: 'pagination', count: totalCount, limit: pageSize, curr: pageNo, jump: getNavigationList});
                }, 0);
            });}}
</script>
</body>

</html>

